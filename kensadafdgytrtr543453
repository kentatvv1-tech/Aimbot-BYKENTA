
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer

local Settings = {

    teamCheck = false,
    fov = 150,
    smoothing = 0.15,
    predictionFactor = 0.165,
    aimbotEnabled = true,
    Toggle = false,

    lockMode = "Head",

    espEnabled = true,
    espType = "2D Box",
    espBoxes = true,
    espNames = true,
    espDistance = true,
    espHealth = true,
    espTracers = false,
    espTeamColor = true,

    useRGBColors = true,
    rgbSpeed = 1.0,
    espColor = Color3.fromRGB(0, 255, 255),
    espColor2 = Color3.fromRGB(255, 0, 255),
    espRainbow = true,
    

    boxThickness = 1,
    boxTransparency = 0.7,
    skeletonThickness = 1,
    skeletonTransparency = 0.5,
    cornerSize = 5,

    showFOV = true,
    fovFilled = false,
    fovThickness = 2,
    fovColor = Color3.fromRGB(255, 50, 50)
}


local currentTarget = nil
local toggleState = false
local espObjects = {}
local rgbHue = 0
local camera = Workspace.CurrentCamera

local FOVring = Drawing.new("Circle")
FOVring.Visible = Settings.showFOV
FOVring.Thickness = Settings.fovThickness
FOVring.Radius = Settings.fov
FOVring.Transparency = 0.8
FOVring.Color = Settings.fovColor
FOVring.Filled = Settings.fovFilled
FOVring.Position = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

-- ============================================
-- AIMBOT CORE FUNCTIONS
-- ============================================
local function getClosestPlayer()
    if not Settings.aimbotEnabled then return nil end
    if not LocalPlayer.Character then return nil end
    
    local closestPlayer = nil
    local closestDistance = Settings.fov
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    
    local localCharacter = LocalPlayer.Character
    local localHumanoidRootPart = localCharacter:FindFirstChild("HumanoidRootPart")
    if not localHumanoidRootPart then return nil end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Settings.teamCheck and player.Team == LocalPlayer.Team then continue end
        
        local character = player.Character
        if not character then continue end
        
        local humanoid = character:FindFirstChild("Humanoid")
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        local head = character:FindFirstChild("Head")
        
        if not (humanoid and humanoidRootPart and head) then continue end
        if humanoid.Health <= 0 then continue end

        local screenPosition, onScreen = camera:WorldToViewportPoint(humanoidRootPart.Position)
        if not onScreen then continue end

        local screenPos = Vector2.new(screenPosition.X, screenPosition.Y)
        local distance = (screenPos - screenCenter).Magnitude
        

        if distance <= closestDistance then
            closestDistance = distance
            closestPlayer = player
        end
    end
    
    return closestPlayer
end

local function getTargetPosition(player)
    if not player or not player.Character then return nil end
    
    local character = player.Character
    local targetPart = character:FindFirstChild(Settings.lockMode)
    
    if not targetPart then
        targetPart = character:FindFirstChild("Head") or character:FindFirstChild("HumanoidRootPart")
    end
    
    if not targetPart then return nil end

    local velocity = targetPart.AssemblyLinearVelocity
    local distance = (targetPart.Position - camera.CFrame.Position).Magnitude
    local travelTime = distance / 1000 -- Simple prediction formula
    
    return targetPart.Position + (velocity * travelTime * Settings.predictionFactor)
end

local function aimAtPosition(targetPosition)
    if not targetPosition then return end
    if not LocalPlayer.Character then return end
    
    local camera = Workspace.CurrentCamera
    local currentCameraCFrame = camera.CFrame

    local direction = (targetPosition - currentCameraCFrame.Position).Unit

    local newCFrame = CFrame.new(currentCameraCFrame.Position, currentCameraCFrame.Position + direction)

    local smoothedCFrame = currentCameraCFrame:Lerp(newCFrame, Settings.smoothing)

    camera.CFrame = smoothedCFrame
end

local function updateAimbot()
    if not Settings.aimbotEnabled then 
        currentTarget = nil
        return 
    end
    

    if Settings.Toggle and not toggleState then
        currentTarget = nil
        return
    end
    
    -- Get closest player
    local closestPlayer = getClosestPlayer()
    
    if closestPlayer then
        currentTarget = closestPlayer
        local targetPosition = getTargetPosition(closestPlayer)
        
        if targetPosition then
            aimAtPosition(targetPosition)
        end
    else
        currentTarget = nil
    end
end

-- ============================================
-- RGB COLOR SYSTEM
-- ============================================
local function HSVtoRGB(h, s, v)
    local r, g, b
    local i = math.floor(h * 6)
    local f = h * 6 - i
    local p = v * (1 - s)
    local q = v * (1 - f * s)
    local t = v * (1 - (1 - f) * s)
    
    i = i % 6
    
    if i == 0 then
        r, g, b = v, t, p
    elseif i == 1 then
        r, g, b = q, v, p
    elseif i == 2 then
        r, g, b = p, v, t
    elseif i == 3 then
        r, g, b = p, q, v
    elseif i == 4 then
        r, g, b = t, p, v
    else
        r, g, b = v, p, q
    end
    
    return Color3.new(r, g, b)
end

local function getRainbowColor()
    rgbHue = (rgbHue + (Settings.rgbSpeed * 0.01)) % 1
    return HSVtoRGB(rgbHue, 1, 1)
end

local function getGradientColor()
    if not Settings.useRGBColors then
        return Settings.espColor
    end
    
    if Settings.espRainbow then
        return getRainbowColor()
    else
        local t = (math.sin(tick() * Settings.rgbSpeed) + 1) / 2
        return Settings.espColor:Lerp(Settings.espColor2, t)
    end
end

local function getTeamColor(player)
    if not Settings.espTeamColor then
        return getGradientColor()
    end
    
    if player.Team == LocalPlayer.Team then
        return Color3.fromRGB(0, 150, 255) -- Blue for team
    else
        return Color3.fromRGB(255, 50, 50) -- Red for enemies
    end
end

-- ============================================
-- 2D ESP SYSTEM
-- ============================================
local function createESP(player)
    if player == LocalPlayer or espObjects[player] then return end
    
    local esp = {
        box = Drawing.new("Square"),
        boxOutline = Drawing.new("Square"),
        name = Drawing.new("Text"),
        distance = Drawing.new("Text"),
        health = Drawing.new("Text"),
        tracer = Drawing.new("Line"),
        skeleton = {},
        corners = {}
    }
    
    -- Box ESP
    esp.box.Visible = false
    esp.box.Thickness = Settings.boxThickness
    esp.box.Filled = false
    esp.box.Transparency = Settings.boxTransparency
    esp.box.Color = Settings.espColor
    
    esp.boxOutline.Visible = false
    esp.boxOutline.Thickness = Settings.boxThickness + 2
    esp.boxOutline.Filled = false
    esp.boxOutline.Transparency = Settings.boxTransparency
    esp.boxOutline.Color = Color3.fromRGB(0, 0, 0)
    
    -- Name ESP
    esp.name.Visible = false
    esp.name.Size = 14
    esp.name.Center = true
    esp.name.Outline = true
    esp.name.OutlineColor = Color3.fromRGB(0, 0, 0)
    esp.name.Color = Settings.espColor
    
    -- Distance ESP
    esp.distance.Visible = false
    esp.distance.Size = 12
    esp.distance.Center = true
    esp.distance.Outline = true
    esp.distance.OutlineColor = Color3.fromRGB(0, 0, 0)
    esp.distance.Color = Settings.espColor
    
    -- Health ESP
    esp.health.Visible = false
    esp.health.Size = 12
    esp.health.Center = true
    esp.health.Outline = true
    esp.health.OutlineColor = Color3.fromRGB(0, 0, 0)
    
    -- Tracer ESP
    esp.tracer.Visible = false
    esp.tracer.Thickness = 1
    esp.tracer.Transparency = 0.5
    esp.tracer.Color = Settings.espColor
    
    -- Create skeleton lines if needed
    if Settings.espType == "Skeleton" then
        local boneConnections = {
            {"Head", "UpperTorso"},
            {"UpperTorso", "LowerTorso"},
            {"UpperTorso", "LeftUpperArm"},
            {"UpperTorso", "RightUpperArm"},
            {"LowerTorso", "LeftUpperLeg"},
            {"LowerTorso", "RightUpperLeg"},
            {"LeftUpperArm", "LeftLowerArm"},
            {"RightUpperArm", "RightLowerArm"},
            {"LeftLowerArm", "LeftHand"},
            {"RightLowerArm", "RightHand"},
            {"LeftUpperLeg", "LeftLowerLeg"},
            {"RightUpperLeg", "RightLowerLeg"},
            {"LeftLowerLeg", "LeftFoot"},
            {"RightLowerLeg", "RightFoot"}
        }
        
        for i = 1, #boneConnections do
            local line = Drawing.new("Line")
            line.Visible = false
            line.Thickness = Settings.skeletonThickness
            line.Transparency = Settings.skeletonTransparency
            line.Color = Settings.espColor
            table.insert(esp.skeleton, line)
        end
    end
    
    -- Create corner boxes if needed
    if Settings.espType == "Corner" then
        for i = 1, 8 do
            local corner = Drawing.new("Square")
            corner.Visible = false
            corner.Thickness = 1
            corner.Filled = true
            corner.Transparency = 0.5
            corner.Size = Vector2.new(Settings.cornerSize, Settings.cornerSize)
            corner.Color = Settings.espColor
            table.insert(esp.corners, corner)
        end
    end
    
    espObjects[player] = esp
    return esp
end

local function updateESP()
    if not Settings.espEnabled then
        for _, esp in pairs(espObjects) do
            esp.box.Visible = false
            esp.boxOutline.Visible = false
            esp.name.Visible = false
            esp.distance.Visible = false
            esp.health.Visible = false
            esp.tracer.Visible = false
            
            for _, line in ipairs(esp.skeleton) do
                line.Visible = false
            end
            
            for _, corner in ipairs(esp.corners) do
                corner.Visible = false
            end
        end
        return
    end
    
    for player, esp in pairs(espObjects) do
        if not player or not player.Character then
            esp.box.Visible = false
            esp.boxOutline.Visible = false
            esp.name.Visible = false
            esp.distance.Visible = false
            esp.health.Visible = false
            esp.tracer.Visible = false
            continue
        end
        
        local character = player.Character
        local humanoid = character:FindFirstChild("Humanoid")
        local hrp = character:FindFirstChild("HumanoidRootPart")
        local head = character:FindFirstChild("Head")
        
        if not (humanoid and hrp and head) or humanoid.Health <= 0 then
            esp.box.Visible = false
            esp.boxOutline.Visible = false
            esp.name.Visible = false
            esp.distance.Visible = false
            esp.health.Visible = false
            esp.tracer.Visible = false
            continue
        end
        
        local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position)
        if not onScreen then
            esp.box.Visible = false
            esp.boxOutline.Visible = false
            esp.name.Visible = false
            esp.distance.Visible = false
            esp.health.Visible = false
            esp.tracer.Visible = false
            continue
        end
        
        -- Get ESP color
        local espColor = getTeamColor(player)
        if Settings.useRGBColors then
            espColor = getRainbowColor()
        end
        
        -- Calculate box size
        local headScreenPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
        local feetScreenPos = camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3, 0))
        
        local height = math.abs(headScreenPos.Y - feetScreenPos.Y)
        local width = height / 2
        local boxPosition = Vector2.new(screenPos.X - width/2, screenPos.Y - height/2)
        local boxSize = Vector2.new(width, height)
        
        -- Update Box ESP
        if Settings.espBoxes and Settings.espType == "2D Box" then
            esp.box.Visible = true
            esp.boxOutline.Visible = true
            esp.box.Size = boxSize
            esp.box.Position = boxPosition
            esp.box.Color = espColor
            
            esp.boxOutline.Size = boxSize
            esp.boxOutline.Position = boxPosition
        else
            esp.box.Visible = false
            esp.boxOutline.Visible = false
        end
        
        -- Update Name ESP
        if Settings.espNames then
            esp.name.Visible = true
            esp.name.Text = player.Name
            esp.name.Position = Vector2.new(screenPos.X, screenPos.Y - height/2 - 20)
            esp.name.Color = espColor
        else
            esp.name.Visible = false
        end
        
        -- Update Distance ESP
        if Settings.espDistance and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local distance = math.floor((hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude)
            esp.distance.Visible = true
            esp.distance.Text = tostring(distance) .. "m"
            esp.distance.Position = Vector2.new(screenPos.X, screenPos.Y + height/2 + 5)
            esp.distance.Color = espColor
        else
            esp.distance.Visible = false
        end
        
        -- Update Health ESP
        if Settings.espHealth then
            local healthPercent = math.floor((humanoid.Health / humanoid.MaxHealth) * 100)
            esp.health.Visible = true
            esp.health.Text = tostring(healthPercent) .. "%"
            esp.health.Position = Vector2.new(screenPos.X, screenPos.Y + height/2 + 20)
            
            local healthColor = Color3.fromRGB(
                255 - (healthPercent * 2.55),
                healthPercent * 2.55,
                0
            )
            esp.health.Color = healthColor
        else
            esp.health.Visible = false
        end
        
        -- Update Tracer ESP
        if Settings.espTracers then
            esp.tracer.Visible = true
            esp.tracer.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y)
            esp.tracer.To = Vector2.new(screenPos.X, screenPos.Y)
            esp.tracer.Color = espColor
        else
            esp.tracer.Visible = false
        end
        
        -- Update Skeleton ESP
        if Settings.espType == "Skeleton" then
            local boneConnections = {
                {"Head", "UpperTorso"},
                {"UpperTorso", "LowerTorso"},
                {"UpperTorso", "LeftUpperArm"},
                {"UpperTorso", "RightUpperArm"},
                {"LowerTorso", "LeftUpperLeg"},
                {"LowerTorso", "RightUpperLeg"},
                {"LeftUpperArm", "LeftLowerArm"},
                {"RightUpperArm", "RightLowerArm"},
                {"LeftLowerArm", "LeftHand"},
                {"RightLowerArm", "RightHand"},
                {"LeftUpperLeg", "LeftLowerLeg"},
                {"RightUpperLeg", "RightLowerLeg"},
                {"LeftLowerLeg", "LeftFoot"},
                {"RightLowerLeg", "RightFoot"}
            }
            
            for i, connection in ipairs(boneConnections) do
                local boneLine = esp.skeleton[i]
                if boneLine then
                    local part1 = character:FindFirstChild(connection[1])
                    local part2 = character:FindFirstChild(connection[2])
                    
                    if part1 and part2 then
                        local pos1, vis1 = camera:WorldToViewportPoint(part1.Position)
                        local pos2, vis2 = camera:WorldToViewportPoint(part2.Position)
                        
                        if vis1 and vis2 then
                            boneLine.Visible = true
                            boneLine.From = Vector2.new(pos1.X, pos1.Y)
                            boneLine.To = Vector2.new(pos2.X, pos2.Y)
                            boneLine.Color = espColor
                        else
                            boneLine.Visible = false
                        end
                    else
                        boneLine.Visible = false
                    end
                end
            end
        end
        
        -- Update Corner Box ESP
        if Settings.espType == "Corner" then
            local corners = {
                Vector2.new(boxPosition.X, boxPosition.Y), -- Top Left
                Vector2.new(boxPosition.X + width, boxPosition.Y), -- Top Right
                Vector2.new(boxPosition.X, boxPosition.Y + height), -- Bottom Left
                Vector2.new(boxPosition.X + width, boxPosition.Y + height), -- Bottom Right
                Vector2.new(boxPosition.X + width/2, boxPosition.Y), -- Top Middle
                Vector2.new(boxPosition.X + width/2, boxPosition.Y + height), -- Bottom Middle
                Vector2.new(boxPosition.X, boxPosition.Y + height/2), -- Left Middle
                Vector2.new(boxPosition.X + width, boxPosition.Y + height/2) -- Right Middle
            }
            
            for i, cornerPos in ipairs(corners) do
                local corner = esp.corners[i]
                if corner then
                    corner.Visible = true
                    corner.Position = cornerPos - Vector2.new(Settings.cornerSize/2, Settings.cornerSize/2)
                    corner.Color = espColor
                end
            end
        end
    end
end

local function removeESP(player)
    local esp = espObjects[player]
    if not esp then return end
    
    -- Remove all drawings
    esp.box:Remove()
    esp.boxOutline:Remove()
    esp.name:Remove()
    esp.distance:Remove()
    esp.health:Remove()
    esp.tracer:Remove()
    
    for _, line in ipairs(esp.skeleton) do
        line:Remove()
    end
    
    for _, corner in ipairs(esp.corners) do
        corner:Remove()
    end
    
    espObjects[player] = nil
end

-- ============================================
-- FIXED UI SYSTEM WITH WORKING TOGGLES
-- ============================================
local mainUI = nil
local isUIVisible = false
local toggleButtons = {} -- à¹€à¸à¹‡à¸š reference à¸‚à¸­à¸‡ toggle buttons

-- Function to create UI
local function createUI()
    if mainUI then 
        mainUI:Destroy()
        mainUI = nil
    end
    
    mainUI = Instance.new("ScreenGui")
    mainUI.Name = "VIP_Aimbot_UI"
    mainUI.ResetOnSpawn = false
    mainUI.IgnoreGuiInset = true
    mainUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    mainUI.Parent = CoreGui
    
    -- Main Container
    local mainContainer = Instance.new("Frame")
    mainContainer.Name = "MainContainer"
    mainContainer.Size = UDim2.new(0, 300, 0, 420)
    mainContainer.Position = UDim2.new(0.5, -150, 0.5, -200)
    mainContainer.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    mainContainer.BackgroundTransparency = 0.05
    mainContainer.BorderSizePixel = 0
    mainContainer.Active = true
    mainContainer.Draggable = true
    mainContainer.Visible = isUIVisible
    mainContainer.Parent = mainUI
    
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0, 8)
    uiCorner.Parent = mainContainer
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainContainer
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = titleBar
    
    -- Title Text
    local titleText = Instance.new("TextLabel")
    titleText.Name = "TitleText"
    titleText.Size = UDim2.new(1, -60, 1, 0)
    titleText.Position = UDim2.new(0, 10, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "ðŸŽ¯Aimbot v1.2 BY : Kenta"
    titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleText.Font = Enum.Font.GothamMedium
    titleText.TextSize = 14
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar
    
    -- Close Button
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -30, 0.5, -12.5)
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeButton.Text = "âœ•"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 14
    closeButton.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeButton
    
    -- Content Frame
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = "ContentFrame"
    contentFrame.Size = UDim2.new(1, -20, 1, -50)
    contentFrame.Position = UDim2.new(0, 10, 0, 40)
    contentFrame.BackgroundTransparency = 1
    contentFrame.BorderSizePixel = 0
    contentFrame.ScrollBarThickness = 4
    contentFrame.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 70)
    contentFrame.ScrollingDirection = Enum.ScrollingDirection.Y
    contentFrame.VerticalScrollBarInset = Enum.ScrollBarInset.Always
    contentFrame.Parent = mainContainer
    
    local uiListLayout = Instance.new("UIListLayout")
    uiListLayout.Padding = UDim.new(0, 8)
    uiListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    uiListLayout.Parent = contentFrame
    
    local uiPadding = Instance.new("UIPadding")
    uiPadding.PaddingLeft = UDim.new(0, 5)
    uiPadding.PaddingRight = UDim.new(0, 5)
    uiPadding.Parent = contentFrame
    
    -- Reset toggle buttons table
    toggleButtons = {}
    
    -- FIXED: Helper function for toggle controls à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡
    local function createToggle(name, settingKey, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, -10, 0, 28)
        frame.BackgroundTransparency = 1
        frame.Parent = contentFrame
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.7, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.Font = Enum.Font.Gotham
        label.TextSize = 13
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = frame
        
        local toggle = Instance.new("TextButton")
        toggle.Name = settingKey -- à¹ƒà¸Šà¹‰à¸Šà¸·à¹ˆà¸­ setting à¹€à¸›à¹‡à¸™ key
        toggle.Size = UDim2.new(0, 50, 0, 22)
        toggle.Position = UDim2.new(0.7, 0, 0.5, -11)
        toggle.BackgroundColor3 = Settings[settingKey] and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(60, 60, 70)
        toggle.Text = Settings[settingKey] and "ON" or "OFF"
        toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
        toggle.Font = Enum.Font.GothamMedium
        toggle.TextSize = 12
        toggle.Parent = frame
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 4)
        corner.Parent = toggle
        
        -- à¹€à¸à¹‡à¸š reference à¸‚à¸­à¸‡ toggle button
        toggleButtons[settingKey] = toggle
        
        -- FIXED: Event handler à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡
        toggle.MouseButton1Click:Connect(function()
            Settings[settingKey] = not Settings[settingKey]
            
            -- à¸­à¸±à¸žà¹€à¸”à¸—à¸›à¸¸à¹ˆà¸¡à¸—à¸±à¸™à¸—à¸µ
            toggle.BackgroundColor3 = Settings[settingKey] and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(60, 60, 70)
            toggle.Text = Settings[settingKey] and "ON" or "OFF"
            
            -- à¹€à¸£à¸µà¸¢à¸ callback à¸–à¹‰à¸²à¸¡à¸µ
            if callback then
                callback(Settings[settingKey])
            end
            
            -- à¸­à¸±à¸žà¹€à¸”à¸— visual à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™
            if settingKey == "showFOV" then
                FOVring.Visible = Settings[settingKey]
            elseif settingKey == "fovFilled" then
                FOVring.Filled = Settings[settingKey]
            elseif settingKey == "espEnabled" then
                -- à¸­à¸±à¸žà¹€à¸”à¸— ESP visibility
                updateESP()
            end
        end)
        
        return frame
    end
    
    -- Helper function for slider controls
    local function createSlider(name, settingKey, min, max, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, -10, 0, 40)
        frame.BackgroundTransparency = 1
        frame.Parent = contentFrame
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 18)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. Settings[settingKey]
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.Font = Enum.Font.Gotham
        label.TextSize = 13
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = frame
        
        local sliderFrame = Instance.new("Frame")
        sliderFrame.Size = UDim2.new(1, 0, 0, 4)
        sliderFrame.Position = UDim2.new(0, 0, 1, -16)
        sliderFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
        sliderFrame.Parent = frame
        
        local sliderCorner = Instance.new("UICorner")
        sliderCorner.CornerRadius = UDim.new(0, 2)
        sliderCorner.Parent = sliderFrame
        
        local fill = Instance.new("Frame")
        fill.Size = UDim2.new((Settings[settingKey] - min) / (max - min), 0, 1, 0)
        fill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        fill.Parent = sliderFrame
        
        local fillCorner = Instance.new("UICorner")
        fillCorner.CornerRadius = UDim.new(0, 2)
        fillCorner.Parent = fill
        
        -- Simple click to adjust
        sliderFrame.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                local percent = (input.Position.X - sliderFrame.AbsolutePosition.X) / sliderFrame.AbsoluteSize.X
                local newValue = math.floor(min + (max - min) * math.clamp(percent, 0, 1))
                
                -- à¸­à¸±à¸žà¹€à¸”à¸—à¸„à¹ˆà¸²à¹ƒà¸™ Settings
                Settings[settingKey] = newValue
                
                -- à¸­à¸±à¸žà¹€à¸”à¸— UI
                fill.Size = UDim2.new(percent, 0, 1, 0)
                label.Text = name .. ": " .. newValue
                
                -- à¹€à¸£à¸µà¸¢à¸ callback
                if callback then
                    callback(newValue)
                end
                
                -- à¸­à¸±à¸žà¹€à¸”à¸— FOV à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™
                if settingKey == "fov" then
                    FOVring.Radius = newValue
                end
            end
        end)
    end
    
    -- Section Divider
    local function createDivider(text)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, -10, 0, 20)
        frame.BackgroundTransparency = 1
        frame.Parent = contentFrame
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = "â”€ " .. text .. " â”€"
        label.TextColor3 = Color3.fromRGB(150, 150, 170)
        label.Font = Enum.Font.GothamMedium
        label.TextSize = 12
        label.Parent = frame
        
        return frame
    end
    
    -- Create Settings Sections à¸”à¹‰à¸§à¸¢ createToggle à¹à¸šà¸šà¹ƒà¸«à¸¡à¹ˆ
    createDivider("ðŸŽ¯ AIMBOT")
    createToggle("Enabled", "aimbotEnabled", function(v)
        -- à¸­à¸±à¸žà¹€à¸”à¸— aimbot state
        if not v then
            currentTarget = nil
        end
    end)
    
    createToggle("Toggle Mode (E)", "Toggle", function(v)
        -- à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸­à¸°à¹„à¸£à¹€à¸žà¸´à¹ˆà¸¡
    end)
    
    createToggle("Team Check", "teamCheck", function(v)
        -- à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸­à¸°à¹„à¸£à¹€à¸žà¸´à¹ˆà¸¡
    end)
    
    createSlider("FOV Size", "fov", 50, 300, function(v)
        FOVring.Radius = v
    end)
    
    createSlider("Smoothing %", "smoothing", 1, 50, function(v)
        Settings.smoothing = v / 100
    end)
    
    createSlider("Prediction %", "predictionFactor", 0, 30, function(v)
        Settings.predictionFactor = v / 100
    end)
    
    createDivider("ðŸ‘ï¸ ESP")
    createToggle("Enabled", "espEnabled", function(v)
        updateESP()
    end)
    
    createToggle("ESP Boxes", "espBoxes", function(v)
        updateESP()
    end)
    
    createToggle("ESP Names", "espNames", function(v)
        updateESP()
    end)
    
    createToggle("ESP Distance", "espDistance", function(v)
        updateESP()
    end)
    
    createToggle("ESP Health", "espHealth", function(v)
        updateESP()
    end)
    
    createToggle("ESP Tracers", "espTracers", function(v)
        updateESP()
    end)
    
    createDivider("ðŸŒˆ RGB COLORS")
    createToggle("RGB Mode", "useRGBColors", function(v)
        -- à¸­à¸±à¸žà¹€à¸”à¸—à¸ªà¸µ ESP
        updateESP()
    end)
    
    createToggle("Rainbow Mode", "espRainbow", function(v)
        -- à¸­à¸±à¸žà¹€à¸”à¸—à¸ªà¸µ ESP
        updateESP()
    end)
    
    createToggle("Team Colors", "espTeamColor", function(v)
        updateESP()
    end)
    
    createDivider("âœ¨ VISUALS")
    createToggle("Show FOV", "showFOV", function(v)
        FOVring.Visible = v
    end)
    
    createToggle("Filled FOV", "fovFilled", function(v)
        FOVring.Filled = v
    end)
    
    -- Panic Button
    local panicFrame = Instance.new("Frame")
    panicFrame.Size = UDim2.new(1, -10, 0, 35)
    panicFrame.BackgroundTransparency = 1
    panicFrame.Parent = contentFrame
    
    local panicButton = Instance.new("TextButton")
    panicButton.Size = UDim2.new(1, 0, 1, 0)
    panicButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    panicButton.Text = "ðŸš¨ PANIC MODE (DEL)"
    panicButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    panicButton.Font = Enum.Font.GothamMedium
    panicButton.TextSize = 13
    panicButton.Parent = panicFrame
    
    local panicCorner = Instance.new("UICorner")
    panicCorner.CornerRadius = UDim.new(0, 6)
    panicCorner.Parent = panicButton
    
    panicButton.MouseButton1Click:Connect(function()
        -- à¸›à¸´à¸”à¸—à¸¸à¸à¸Ÿà¸µà¹€à¸ˆà¸­à¸£à¹Œ
        Settings.aimbotEnabled = false
        Settings.espEnabled = false
        toggleState = false
        
        -- à¸­à¸±à¸žà¹€à¸”à¸— toggle buttons à¸—à¸±à¸™à¸—à¸µ
        for key, toggle in pairs(toggleButtons) do
            if toggle and toggle:IsA("TextButton") then
                toggle.BackgroundColor3 = Settings[key] and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(60, 60, 70)
                toggle.Text = Settings[key] and "ON" or "OFF"
            end
        end
        
        -- à¸›à¸´à¸” UI
        mainContainer.Visible = false
        isUIVisible = false
    end)
    
    -- Update canvas size
    task.spawn(function()
        task.wait(0.1)
        if contentFrame and uiListLayout then
            contentFrame.CanvasSize = UDim2.new(0, 0, 0, uiListLayout.AbsoluteContentSize.Y + 20)
        end
    end)
    
    -- EVENT HANDLERS
    closeButton.MouseButton1Click:Connect(function()
        mainContainer.Visible = false
        isUIVisible = false
    end)
    
    return mainContainer
end

-- Function to toggle UI visibility
local function toggleUI()
    isUIVisible = not isUIVisible
    
    if not mainUI then
        createUI()
    end
    
    local mainContainer = mainUI:FindFirstChild("MainContainer")
    if mainContainer then
        mainContainer.Visible = isUIVisible
    else
        createUI()
        mainUI:FindFirstChild("MainContainer").Visible = isUIVisible
    end
end

-- ============================================
-- INITIALIZATION
-- ============================================
-- Create ESP for existing players
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        createESP(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    task.wait(1)
    if player ~= LocalPlayer then
        createESP(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end)

-- ============================================
-- KEYBINDS
-- ============================================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    -- Toggle aimbot with E (à¹€à¸‰à¸žà¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸´à¸” Toggle Mode)
    if input.KeyCode == Enum.KeyCode.E then
        if Settings.Toggle then
            toggleState = not toggleState
            print("ðŸŽ¯ Aimbot Toggle: " .. (toggleState and "ON" or "OFF"))
        end
    end
    
    -- Toggle UI with RightShift
    if input.KeyCode == Enum.KeyCode.RightShift then
        toggleUI()
    end
    
    -- Panic mode with Delete
    if input.KeyCode == Enum.KeyCode.Delete then
        Settings.aimbotEnabled = false
        Settings.espEnabled = false
        toggleState = false
        
        -- à¸­à¸±à¸žà¹€à¸”à¸— toggle buttons à¸–à¹‰à¸²à¸¡à¸µ UI
        if mainUI and toggleButtons then
            for key, toggle in pairs(toggleButtons) do
                if toggle and toggle:IsA("TextButton") then
                    toggle.BackgroundColor3 = Settings[key] and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(60, 60, 70)
                    toggle.Text = Settings[key] and "ON" or "OFF"
                end
            end
        end
        
        print("ðŸš¨ Panic Mode Activated!")
    end
end)

-- ============================================
-- MAIN LOOP
-- ============================================
RunService.RenderStepped:Connect(function()
    -- Update FOV circle
    FOVring.Position = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    
    -- Update ESP
    updateESP()
    
    -- Update FOV color with RGB
    if Settings.useRGBColors then
        FOVring.Color = getRainbowColor()
    end
    
    -- Update Aimbot
    updateAimbot()
end)

-- ============================================
-- STARTUP
-- ============================================
-- Create UI but hide it initially
task.spawn(function()
    task.wait(1)
    createUI()
    if mainUI then
        local container = mainUI:FindFirstChild("MainContainer")
        if container then
            container.Visible = false
        end
    end
end)

print("âœ…  Aimbot v3.0 BY : kenta eiei - With Working Aimbot Loaded!")
print("ðŸŽ® Features:")
print("   â€¢ Working Aimbot System")
print("   â€¢ Toggle Buttons (ON/OFF works!)")
print("   â€¢ Optimized 2D ESP")
print("   â€¢ RGB Color System")
print("ðŸŽ¯ Controls:")
print("   E = Toggle Aimbot (when Toggle Mode is ON)")
print("   RightShift = Toggle UI")
print("   Delete = Panic Mode")
print("ðŸŽ¯ Aimbot Settings:")
print("   â€¢ FOV: " .. Settings.fov)
print("   â€¢ Smoothing: " .. (Settings.smoothing * 100) .. "%")
print("   â€¢ Prediction: " .. (Settings.predictionFactor * 100) .. "%")
print("   â€¢ Lock Mode: " .. Settings.lockMode)
print("https://www.youtube.com/@KENTAAAEIEI")
